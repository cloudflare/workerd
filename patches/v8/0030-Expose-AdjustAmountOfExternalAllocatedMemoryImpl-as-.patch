From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Aditya Tewari <adityaatewari@gmail.com>
Date: Wed, 15 Jan 2025 12:00:00 +0000
Subject: Expose AdjustAmountOfExternalAllocatedMemoryImpl as public API

The deprecated AdjustAmountOfExternalAllocatedMemory is being replaced
by ExternalMemoryAccounter, but ExternalMemoryAccounter requires that
adjustments return to zero before destruction. This is incompatible with
workerd's design where external memory may outlive the isolate.

V8 already has AdjustAmountOfExternalAllocatedMemoryImpl as a private
method. This patch simply makes it public for embedder use.

Signed-off-by: Aditya Tewari <adityaatewari@gmail.com>

diff --git a/include/v8-isolate.h b/include/v8-isolate.h
index 067c9f3fec9e21890a1c8d5d1c430d1a473c1a4c..07987b7af4d1dee4731c3006258fad67d02fd526 100644
--- a/include/v8-isolate.h
+++ b/include/v8-isolate.h
@@ -1093,6 +1093,14 @@ class V8_EXPORT Isolate {
    */
   size_t GetHeapSize();
 
+  /**
+   * Adjusts external memory without destructor constraints.
+   * This directly calls the internal implementation without the
+   * zero-balance requirement of ExternalMemoryAccounter.
+   * Use when external memory may outlive the isolate.
+   */
+  int64_t AdjustAmountOfExternalAllocatedMemoryImpl(int64_t change_in_bytes);
+
   /**
    * Returns heap profiler for this isolate. Will return NULL until the isolate
    * is initialized.
@@ -1906,7 +1914,6 @@ class V8_EXPORT Isolate {
 
   internal::ValueHelper::InternalRepresentationType GetDataFromSnapshotOnce(
       size_t index);
-  int64_t AdjustAmountOfExternalAllocatedMemoryImpl(int64_t change_in_bytes);
   void HandleExternalMemoryInterrupt();
 };
 
