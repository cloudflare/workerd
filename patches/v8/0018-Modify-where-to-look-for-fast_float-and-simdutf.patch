From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Erik Corry <erikcorry@chromium.org>
Date: Mon, 3 Mar 2025 22:30:37 +0100
Subject: Modify where to look for fast_float and simdutf.

Similar to fp16, these dependencies now needs to be downloaded by bazel.

Signed-off-by: James M Snell <jsnell@cloudflare.com>

diff --git a/BUILD.bazel b/BUILD.bazel
index 35a076ee7c124f33afc4f63aeace1eb928be643b..881f0ae62987d7737e91a8638a5e9d0b0a2b6af2 100644
--- a/BUILD.bazel
+++ b/BUILD.bazel
@@ -4536,17 +4536,19 @@ cc_library(
     ],
 )
 
-cc_library(
-  name = "simdutf",
-  srcs = ["third_party/simdutf/simdutf.cpp"],
-  hdrs = ["third_party/simdutf/simdutf.h"],
-  copts = select({
-        "@v8//bazel/config:is_clang": ["-std=c++20"],
-        "@v8//bazel/config:is_gcc": ["-std=gnu++2a"],
-        "@v8//bazel/config:is_windows": ["/std:c++20"],
-        "//conditions:default": [],
-    }),
-)
+# The simdutf library is commented out to avoid conflicts with
+# the version we use in workers
+# cc_library(
+#   name = "simdutf",
+#   srcs = ["third_party/simdutf/simdutf.cpp"],
+#   hdrs = ["third_party/simdutf/simdutf.h"],
+#   copts = select({
+#         "@v8//bazel/config:is_clang": ["-std=c++20"],
+#         "@v8//bazel/config:is_gcc": ["-std=gnu++2a"],
+#         "@v8//bazel/config:is_windows": ["/std:c++20"],
+#         "//conditions:default": [],
+#     }),
+# )
 
 v8_library(
     name = "v8_libshared",
@@ -4577,15 +4579,15 @@ v8_library(
     ],
     deps = [
         ":lib_dragonbox",
-        "//third_party/fast_float/src:fast_float",
         ":lib_fp16",
-        ":simdutf",
         ":v8_libbase",
         "@abseil-cpp//absl/container:btree",
         "@abseil-cpp//absl/container:flat_hash_map",
         "@abseil-cpp//absl/container:flat_hash_set",
         "@abseil-cpp//absl/functional:overload",
         "@highway//:hwy",
+        "@fast_float",
+        "@simdutf",
     ],
 )
 
diff --git a/src/builtins/builtins-typed-array.cc b/src/builtins/builtins-typed-array.cc
index d283ace0bb0ad143de3d6d2f8d83a2e18a204cc5..fc17478770ff46d919adc473a1f3832c02134f1d 100644
--- a/src/builtins/builtins-typed-array.cc
+++ b/src/builtins/builtins-typed-array.cc
@@ -2,6 +2,7 @@
 // Use of this source code is governed by a BSD-style license that can be
 // found in the LICENSE file.
 
+#include "simdutf.h"
 #include "src/base/logging.h"
 #include "src/base/macros.h"
 #include "src/builtins/builtins-utils-inl.h"
@@ -15,7 +16,6 @@
 #include "src/objects/objects-inl.h"
 #include "src/objects/option-utils.h"
 #include "src/objects/simd.h"
-#include "third_party/simdutf/simdutf.h"
 
 namespace v8::internal {
 
diff --git a/src/objects/string-inl.h b/src/objects/string-inl.h
index 829d678168cf194d06832db7b1d27c5c13e7ab2a..0193ad2176f2aa3e608b087a42af4cba975f76de 100644
--- a/src/objects/string-inl.h
+++ b/src/objects/string-inl.h
@@ -12,6 +12,8 @@
 #include <type_traits>
 
 #include "absl/functional/overload.h"
+#include "simdutf.h"
+#include "src/base/template-utils.h"
 #include "src/common/assert-scope.h"
 #include "src/common/globals.h"
 #include "src/execution/isolate-utils.h"
@@ -38,7 +40,6 @@
 #include "src/torque/runtime-macro-shims.h"
 #include "src/torque/runtime-support.h"
 #include "src/utils/utils.h"
-#include "third_party/simdutf/simdutf.h"
 
 // Has to be the last include (doesn't have include guards):
 #include "src/objects/object-macros.h"
diff --git a/src/objects/string.h b/src/objects/string.h
index c6003839758fa44cce5dbb1359b95605080ba22f..c8ef0434577d960f2d666b79e4b3896390ad270d 100644
--- a/src/objects/string.h
+++ b/src/objects/string.h
@@ -8,6 +8,7 @@
 #include <memory>
 #include <optional>
 
+#include "simdutf.h"
 #include "src/base/bits.h"
 #include "src/base/export-template.h"
 #include "src/base/small-vector.h"
@@ -21,7 +22,6 @@
 #include "src/objects/tagged.h"
 #include "src/sandbox/external-pointer.h"
 #include "src/strings/unicode-decoder.h"
-#include "third_party/simdutf/simdutf.h"
 
 // Has to be the last include (doesn't have include guards):
 #include "src/objects/object-macros.h"
diff --git a/src/strings/unicode-inl.h b/src/strings/unicode-inl.h
index 25f3d0375e7f1a71cb1e58f6244b3000b81a5bb2..3f1b5b33f3432ad8046d69382e25326a9776a9f9 100644
--- a/src/strings/unicode-inl.h
+++ b/src/strings/unicode-inl.h
@@ -8,9 +8,9 @@
 #include "src/strings/unicode.h"
 // Include the non-inl header before the rest of the headers.
 
+#include "simdutf.h"
 #include "src/base/logging.h"
 #include "src/utils/utils.h"
-#include "third_party/simdutf/simdutf.h"
 
 namespace unibrow {
 
diff --git a/src/strings/unicode.cc b/src/strings/unicode.cc
index d213ea68e8ad1dde4eec3ba97b6f9f23db6173e5..74687f7463e3a133095a3cfd7a00e0bf7da0132b 100644
--- a/src/strings/unicode.cc
+++ b/src/strings/unicode.cc
@@ -22,7 +22,7 @@
 #endif
 
 #include "hwy/highway.h"
-#include "third_party/simdutf/simdutf.h"
+#include "simdutf.h"
 
 namespace unibrow {
 
