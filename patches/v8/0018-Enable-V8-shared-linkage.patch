From 5b97cd87940333e04be78d2033ba200de5f680ce Mon Sep 17 00:00:00 2001
From: Felix Hanau <felix@cloudflare.com>
Date: Sun, 9 Jul 2023 18:46:20 -0400
Subject: [PATCH 18/22] Enable V8 shared linkage

---
 BUILD.bazel    | 11 +++++++----
 bazel/defs.bzl |  3 ---
 2 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/BUILD.bazel b/BUILD.bazel
index 28d8993c840..8930baf61ba 100644
--- a/BUILD.bazel
+++ b/BUILD.bazel
@@ -1409,6 +1409,7 @@ filegroup(
         "src/builtins/constants-table-builder.cc",
         "src/builtins/constants-table-builder.h",
         "src/builtins/data-view-ops.h",
+        "src/builtins/profile-data-reader.cc",
         "src/builtins/profile-data-reader.h",
         "src/codegen/aligned-slot-allocator.cc",
         "src/codegen/aligned-slot-allocator.h",
@@ -1592,7 +1593,6 @@ filegroup(
         "src/execution/futex-emulation.h",
         "src/execution/interrupts-scope.cc",
         "src/execution/interrupts-scope.h",
-        "src/execution/isolate.cc",
         "src/execution/isolate.h",
         "src/execution/isolate-data.h",
         "src/execution/isolate-inl.h",
@@ -3135,7 +3135,6 @@ filegroup(
 filegroup(
     name = "v8_compiler_files",
     srcs = [
-        "src/builtins/profile-data-reader.h",
         "src/compiler/access-builder.cc",
         "src/compiler/access-builder.h",
         "src/compiler/access-info.cc",
@@ -3715,8 +3714,6 @@ filegroup(
         "src/builtins/growable-fixed-array-gen.cc",
         "src/builtins/growable-fixed-array-gen.h",
         "src/builtins/number-builtins-reducer-inl.h",
-        "src/builtins/profile-data-reader.cc",
-        "src/builtins/profile-data-reader.h",
         "src/builtins/setup-builtins-internal.cc",
         "src/builtins/torque-csa-header-includes.h",
         "src/codegen/turboshaft-builtins-assembler-inl.h",
@@ -3989,6 +3986,7 @@ filegroup(
         "src/snapshot/snapshot-empty.cc",
         "src/snapshot/static-roots-gen.cc",
         "src/snapshot/static-roots-gen.h",
+        "src/execution/isolate.cc",
     ],
 )
 
@@ -4099,6 +4097,10 @@ filegroup(
     name = "noicu/snapshot_files",
     srcs = [
         "src/init/setup-isolate-deserialize.cc",
+        # Not a snapshot file per se, but depends on symbols only present in the snapshot (or
+        # through a placeholder when building the snapshot itself); having it here makes using
+        # shared linkage for the main v8 target possible.
+        "src/execution/isolate.cc",
     ] + select({
         "@v8//bazel/config:v8_target_arm": [
             "google3/snapshots/arm/noicu/embedded.S",
@@ -4116,6 +4118,7 @@ filegroup(
     name = "icu/snapshot_files",
     srcs = [
         "src/init/setup-isolate-deserialize.cc",
+        "src/execution/isolate.cc",
     ] + select({
         "@v8//bazel/config:v8_target_arm": [
             "google3/snapshots/arm/icu/embedded.S",
diff --git a/bazel/defs.bzl b/bazel/defs.bzl
index ef21af9febf..a0c12c587c4 100644
--- a/bazel/defs.bzl
+++ b/bazel/defs.bzl
@@ -298,7 +298,6 @@ def v8_library(
             copts = copts + default.copts,
             linkopts = linkopts + default.linkopts,
             alwayslink = 1,
-            linkstatic = 1,
             **kwargs
         )
 
@@ -317,7 +316,6 @@ def v8_library(
             copts = copts + default.copts + ENABLE_I18N_SUPPORT_DEFINES,
             linkopts = linkopts + default.linkopts,
             alwayslink = 1,
-            linkstatic = 1,
             **kwargs
         )
 
@@ -337,7 +335,6 @@ def v8_library(
             copts = copts + default.copts,
             linkopts = linkopts + default.linkopts,
             alwayslink = 1,
-            linkstatic = 1,
             **kwargs
         )
 
-- 
2.43.0

