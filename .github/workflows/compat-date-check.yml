name: Compatibility Date Check

on:
  pull_request:
    paths:
      - 'src/workerd/io/compatibility-date.capnp'
    types: [opened, synchronize, labeled, unlabeled]
  workflow_dispatch:
    inputs:
      min_days:
        description: 'Minimum days in the future for new flag dates'
        required: false
        default: 7
        type: number

concurrency:
  group: compat-date-check-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  check-compat-dates:
    runs-on: ubuntu-latest
    # Skip if PR has the bypass label
    if: ${{ !contains(github.event.pull_request.labels.*.name, 'urgent-compat-flag') }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
          show-progress: false

      - name: Setup Runner
        uses: ./.github/actions/setup-runner

      - name: Build flag dumper (PR branch)
        run: |
          bazel build //src/workerd/tools:compatibility-date-dump

      - name: Get PR flags
        run: |
          bazel-bin/src/workerd/tools/compatibility-date-dump > pr-flags.json

      - name: Checkout base branch
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}

      - name: Build flag dumper (base branch)
        run: |
          bazel build //src/workerd/tools:compatibility-date-dump

      - name: Get baseline flags
        run: |
          bazel-bin/src/workerd/tools/compatibility-date-dump > baseline-flags.json

      - name: Validate new flag dates
        id: validate
        run: |
          MIN_DAYS="${{ inputs.min_days || '7' }}"
          MIN_DATE=$(date -d "+${MIN_DAYS} days" +%Y-%m-%d)

          echo "Minimum allowed date: $MIN_DATE (today + $MIN_DAYS days)"

          # Find flags in PR but not in baseline (new flags)
          NEW_FLAGS=$(jq -s '
            (.[1].flags | map(.enableFlag)) as $base |
            .[0].flags | map(select(.enableFlag as $f | $base | index($f) | not))
          ' pr-flags.json baseline-flags.json)

          echo "New flags found:"
          echo "$NEW_FLAGS" | jq -r '.[] | "  - \(.enableFlag)"'

          # Check each new flag's date
          VIOLATIONS=$(echo "$NEW_FLAGS" | jq --arg min "$MIN_DATE" '
            map(select(.date != "" and .date < $min)) |
            map({
              field: .field,
              enableFlag: .enableFlag,
              date: .date,
              minDate: $min
            })
          ')

          VIOLATION_COUNT=$(echo "$VIOLATIONS" | jq 'length')

          if [ "$VIOLATION_COUNT" -gt 0 ]; then
            echo "has_violations=true" >> $GITHUB_OUTPUT

            # Create markdown table for the error message
            {
              echo "## ⚠️ Compatibility Date Validation Failed"
              echo ""
              echo "New compatibility flags must have dates at least **$MIN_DAYS days** in the future."
              echo ""
              echo "| Field | Flag Name | Current Date | Minimum Required |"
              echo "|-------|-----------|--------------|------------------|"
              echo "$VIOLATIONS" | jq -r '.[] | "| `\(.field)` | `\(.enableFlag)` | \(.date) | \(.minDate) |"'
              echo ""
              echo "### How to fix"
              echo "Update the \`\$compatEnableDate\` in \`compatibility-date.capnp\` to a date >= **$MIN_DATE**."
              echo ""
              echo "### Bypass"
              echo "If this is urgent, add the \`urgent-compat-flag\` label to bypass this check."
            } > violation-report.md

            cat violation-report.md

            echo "::error::New compatibility flags must have dates at least $MIN_DAYS days in the future"
            exit 1
          fi

          echo "has_violations=false" >> $GITHUB_OUTPUT
          echo "✓ All new compatibility flag dates are valid (>= $MIN_DATE)"

      - name: Post comment on failure
        if: failure() && steps.validate.outputs.has_violations == 'true'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          path: violation-report.md

      - name: Remove comment on success
        if: success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          only_update: true
          message: |
            ✅ Compatibility date validation passed. All new flags have dates sufficiently far in the future.
