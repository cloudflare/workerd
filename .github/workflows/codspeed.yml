name: CodSpeed Benchmarks

on:
  pull_request:
    paths-ignore:
      - 'docs/**'
      - 'justfile'
      - '.devcontainer'
      - '**/*.md'
      - '.gitignore'
  merge_group:
  push:
    branches:
      - main

concurrency:
  group: codspeed.yml-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  benchmarks:
    name: Run benchmarks
    runs-on: ubuntu-22.04
    env:
      BAZEL_ARGS: --config=ci --config=ci-linux --@codspeed_cpp//core:codspeed_mode=instrumentation --compilation_mode=dbg --copt=-O2 --remote_cache=https://bazel:${{ secrets.BAZEL_CACHE_KEY }}@bazel-remote-cache.devprod.cloudflare.dev
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false

      - name: Cache
        id: cache
        uses: actions/cache@v4
        with:
          path: ~/bazel-disk-cache
          key: bazel-disk-cache-benchmarks-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.bazelversion', '.bazelrc', 'WORKSPACE') }}

      - name: Setup Linux
        run: |
          export DEBIAN_FRONTEND=noninteractive
          wget https://apt.llvm.org/llvm.sh
          sed -i '/apt-get install/d' llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 18
          sudo apt-get install -y --no-install-recommends clang-18 lld-18 libunwind-18 libc++abi1-18 libc++1-18 libc++-18-dev
          echo "build:linux --action_env=CC=/usr/lib/llvm-18/bin/clang" >> .bazelrc
          echo "build:linux --host_action_env=CC=/usr/lib/llvm-18/bin/clang" >> .bazelrc

      - name: Build benchmarks
        run: |
          bazel build ${{ env.BAZEL_ARGS }} //src/workerd/tests:all_benchmarks

      - name: Run benchmarks
        uses: CodSpeedHQ/action@v3
        with:
          run: bazel-bin/src/workerd/tests/run_benchmarks.sh

      - name: Bazel shutdown
        run: bazel shutdown
