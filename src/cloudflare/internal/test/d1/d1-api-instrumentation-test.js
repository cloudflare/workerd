// Copyright (c) 2017-2023 Cloudflare, Inc.
// Licensed under the Apache 2.0 license found in the LICENSE file or at:
//     https://opensource.org/licenses/Apache-2.0
import * as assert from 'node:assert';
import {
  createInstrumentationState,
  createTailStreamHandler,
  runInstrumentationTest,
} from 'instrumentation-test-helper';

// Create module-level state using the helper
const state = createInstrumentationState();

export default {
  tailStream: createTailStreamHandler(state),
};

export const test = {
  async test() {
    await runInstrumentationTest(state, expectedSpans, {
      testName: 'D1 instrumentation',
      logReceived: true,
    });
  },
};

const expectedSpans = [
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/execute?resultsFormat=NONE',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 231n,
    'http.response.status_code': 200n,
    'http.response.body.size': 187n,
    closed: true,
  },
  { name: 'd1_run', 'db.system.name': 'cloudflare-d1', closed: true },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 257n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/execute?resultsFormat=NONE',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 188n,
    closed: true,
  },
  { name: 'd1_run', 'db.system.name': 'cloudflare-d1', closed: true },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/execute?resultsFormat=NONE',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 40n,
    'http.response.status_code': 200n,
    'http.response.body.size': 188n,
    closed: true,
  },
  { name: 'd1_run', 'db.system.name': 'cloudflare-d1', closed: true },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 223n,
    'http.response.status_code': 200n,
    'http.response.body.size': 329n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/execute?resultsFormat=NONE',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 40n,
    'http.response.status_code': 200n,
    'http.response.body.size': 187n,
    closed: true,
  },
  { name: 'd1_run', 'db.system.name': 'cloudflare-d1', closed: true },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/execute?resultsFormat=NONE',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 223n,
    'http.response.status_code': 200n,
    'http.response.body.size': 355n,
    closed: true,
  },
  { name: 'd1_run', 'db.system.name': 'cloudflare-d1', closed: true },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 31n,
    'http.response.status_code': 200n,
    'http.response.body.size': 216n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 31n,
    'http.response.status_code': 200n,
    'http.response.body.size': 217n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 31n,
    'http.response.status_code': 200n,
    'http.response.body.size': 216n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 31n,
    'http.response.status_code': 200n,
    'http.response.body.size': 216n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 329n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 327n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 330n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 42n,
    'http.response.status_code': 200n,
    'http.response.body.size': 330n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 294n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 293n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 294n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 294n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 292n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 292n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 293n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 61n,
    'http.response.status_code': 200n,
    'http.response.body.size': 292n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 125n,
    'http.response.status_code': 200n,
    'http.response.body.size': 588n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 79n,
    'http.response.status_code': 200n,
    'http.response.body.size': 220n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 79n,
    'http.response.status_code': 200n,
    'http.response.body.size': 220n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 79n,
    'http.response.status_code': 200n,
    'http.response.body.size': 218n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 79n,
    'http.response.status_code': 200n,
    'http.response.body.size': 220n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 79n,
    'http.response.status_code': 200n,
    'http.response.body.size': 220n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 298n,
    'http.response.status_code': 200n,
    'http.response.body.size': 846n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 45n,
    'http.response.status_code': 200n,
    'http.response.body.size': 352n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 45n,
    'http.response.status_code': 200n,
    'http.response.body.size': 353n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 45n,
    'http.response.status_code': 200n,
    'http.response.body.size': 353n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 45n,
    'http.response.status_code': 200n,
    'http.response.body.size': 353n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 76n,
    'http.response.status_code': 200n,
    'http.response.body.size': 235n,
    closed: true,
  },
  {
    name: 'fetch',
    'network.protocol.name': 'http',
    'network.protocol.version': 'HTTP/1.1',
    'http.request.method': 'POST',
    'url.full': 'http://d1/query?resultsFormat=ROWS_AND_COLUMNS',
    'http.request.header.content-type': 'application/json',
    'http.request.body.size': 117n,
    'http.response.status_code': 200n,
    'http.response.body.size': 633n,
    closed: true,
  },
];
